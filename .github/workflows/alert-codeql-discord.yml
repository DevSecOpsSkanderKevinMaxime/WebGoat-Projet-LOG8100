name: Alert Discord on CodeQL Vulnerabilities

on:
  schedule:
    - cron: '0 0 * * 1'  # ExÃ©cute chaque semaine
  workflow_dispatch:  # Permet de lancer manuellement
  pull_request:
    branches: [ main ]
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read  # Add this line to access security alerts

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: CodeQL Alerts to Discord
        env:
          DISCORD: ${{ secrets.DISCORDTWO }}
          GH_TOKEN: ${{ secrets.TOKEN_SKANDER }}
        run: |
          echo "Fetching CodeQL alerts from the repository..."
          alerts=$(gh api -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/code-scanning/alerts)

          # Check if alerts exist
          if [[ "$alerts" == "[]" ]]; then
            echo "No CodeQL vulnerabilities found."
            exit 0
          fi

          # Extract and format alerts
          echo "Formatting alerts..."
          formatted_alerts=$(echo "$alerts" | jq -r '.[] |
          "ðŸš¨ **Vulnerability**: \(.rule.id)\n" +
          "**Severity**: \(.rule.severity | ascii_upcase)\n" +
          "**Description**: \(.rule.description)\n" +
          "**File**: \(.most_recent_instance.location.path)\n" +
          "**Line**: \(.most_recent_instance.location.start_line)\n" +
          "**Link**: [View Details](\(.html_url))\n---"')

          # Send formatted alerts to Discord
          echo "$formatted_alerts" | while read -r alert; do
            curl -H "Content-Type: application/json" \
                 -d "$(jq -n --arg content "$alert" '{content: $content}')" \
                 "$DISCORD"
          done