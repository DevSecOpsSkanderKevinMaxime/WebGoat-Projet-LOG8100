name: Alert Discord on CodeQL Vulnerabilities

on:
  schedule:
    - cron: '0 0 * * 1'  # Ex√©cute chaque semaine
  workflow_dispatch:  # Permet de lancer manuellement
  pull_request:
    branches: [ main ]
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read  # Permet d'acc√©der aux alertes de s√©curit√©

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch and Send CodeQL Alerts to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORDTWO }}
          GH_TOKEN: ${{ secrets.TOKEN_SKANDER }}
        run: |
          echo "Fetching CodeQL alerts from the repository..."
          alerts=$(gh api -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/code-scanning/alerts)

          # Check if alerts exist
          if [[ "$alerts" == "[]" ]]; then
            echo "No CodeQL vulnerabilities found."
            exit 0
          fi

          # Extract and format alerts
          echo "Formatting alerts..."
          formatted_alerts=$(echo "$alerts" | jq -r '.[] |
            "üö® **Vulnerability**: \(.rule.id)\n**Severity**: \(.rule.severity | ascii_upcase)\n**Description**: \(.rule.description)\n"')

          # Send formatted alerts to Discord
          echo "$formatted_alerts" | while IFS= read -r alert; do
            echo "Sending alert to Discord..."
            curl -X POST \
                 -H "Content-Type: application/json" \
                 -d "$(jq -n --arg content "$alert" '{content: $content}')" \
                 "$DISCORD_WEBHOOK"
          done
