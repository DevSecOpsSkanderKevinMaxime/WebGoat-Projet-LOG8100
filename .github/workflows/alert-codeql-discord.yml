name: Alert Discord on CodeQL Vulnerabilities

on:
  schedule:
    - cron: '0 0 * * 1'  # Ex√©cute chaque semaine
  workflow_dispatch:  # Permet de lancer manuellement
  pull_request:
    branches: [ main ]
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read  # Add this line to access security alerts

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch CodeQL alerts
        env:
            DISCORD: ${{ secrets.DISCORDTWO }}
            GH_TOKEN: ${{ secrets.TOKEN_SKANDER }}
        run: |
          echo "Authenticating with GitHub CLI..."
          gh auth status || gh auth login --with-token <<< "$GH_TOKEN"

          echo "Fetching CodeQL alerts from the repository..."
          alerts=$(gh api -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/code-scanning/alerts)

          echo "Alerts Response: $alerts"

          if [[ -z "$alerts" || "$alerts" == "[]" ]]; then
            echo "No vulnerabilities found."
          else
            echo "Vulnerabilities found."
            # Convert alerts to Discord message
            discord_message=$(echo "$alerts" | jq -r '.[0] | {content: .html_url}' | jq -c .)

            echo "Sending alerts to Discord..."
            curl -H "Content-Type: application/json" -d "$discord_message" $DISCORD
          fi

