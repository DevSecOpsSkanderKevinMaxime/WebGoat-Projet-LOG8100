name: Alert Discord on Vulnerabilities

on:
  schedule:
    - cron: '0 0 * * 1'  # Ex√©cute chaque semaine
  workflow_dispatch:  # Permet de lancer manuellement
  pull_request:
    branches: [ main ]
  push:
    branches:
        - kevin/test

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
        contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Dependabot Alerts to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD}}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching Dependabot alerts..."
          alerts=$(gh api -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/dependabot/alerts)

          if [[ "$alerts" != "[]" ]]; then
            echo "Found vulnerabilities. Sending to Discord..."
            curl -H "Content-Type: application/json" -d '{
              "content": "Dependabot found vulnerabilities in the repository! Details: '$alerts'"
            }' $DISCORD_WEBHOOK
          else
            echo "No vulnerabilities found."
          fi
